MAKENAME  = $(CMPNAME)
CC        = $(COMPILER)
OBJC      = $(O2H)
MODEL     = $(PROCESSOR)
PDE       = $(PDEPATH)
BOARD     = $(DEVTOOL)
LINKFILE  = $(LINKLIB)
ELF_FLAGS =  -EL -march=24kc -msoft-float -lgcc -Wl,--defsym,_min_heap_size=8192 -D__PIC32MX__ -D__$(MODEL)__ -I ../tools/pic32mx/include -T ../tools/pic32mx/lkr/elf32pic32mx.x
RM        = rm -f
COPY      = cp

all: clean build

build:
		cd $(SOURCE)/source; $(MAKE) -f$(MAKENAME) COMPILER=$(COMPILER) link

link:
		$(CC) $(ELF_FLAGS) -D $(BOARD) -Wl,-Map=output.map -I "../tools/pic32mx/include/" -I "../tools/pic32mx/include/pinguino/" \
        -I "../tools/pic32mx/include/non-free/" -I "../obj/non-free/" -I $(PDE) \
        -o main32.elf main32.c "../obj/non-free/crt0.S" "ISRwrapper.S" "../obj/non-free/usb/libcdc.a" "../obj/non-free/processor.o" $(LINKFILE) -lgcc -lc -lm
		$(OBJC) -O ihex main32.elf main32.hex
		#This remove wrong routine
		grep --binary --invert-match '^:040000059D006000FA' main32.hex > temp
		mv temp main32.hex      

clean:
		$(RM) main32.elf
		$(RM) main32.hex
		$(RM) $(SOURCE)/obj/non-free/processor.o
		$(COPY) $(SOURCE)/obj/non-free/$(MODEL)/processor.pic32 $(SOURCE)/obj/non-free/processor.o
