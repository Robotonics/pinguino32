MAKENAME  = $(CMPNAME)
CC        = $(COMPILER)
OBJC      = $(O2H)
MODEL     = $(PROCESSOR)
BOARD     = $(DEVTOOL)
PDE       = $(PDEPATH)
LINKFILE  = $(LINKLIB)
FLAGS     = -mprocessor=$(MODEL) -x c -c
ELF_FLAGS = -nostdlib -lgcc

RM        = rm -f
COPY      = cp

all: clean build

build:
		cd $(SOURCE)/source; $(MAKE) -f$(MAKENAME) COMPILER=$(COMPILER) link

link:
		$(CC) $(ELF_FLAGS) -D $(BOARD) -mprocessor=$(MODEL) -Wl,--defsym,_min_heap_size=8192 \
        -I "../tools/pic32mx/include/" -I "../tools/pic32mx/include/pinguino/" \
        -I "../tools/pic32mx/include/non-free/" -I "../obj/non-free/" -I $(PDE) \
        -o main32.elf main32.c "../obj/non-free/crt0.S" "../obj/non-free/processor.o" $(LINKFILE) -lm -lc -lgcc
		$(OBJC) -O ihex main32.elf main32.hex
		#This remove wrong routine
		grep --binary --invert-match '^:040000059D006000FA' main32.hex > temp
		mv temp main32.hex      

clean:
		$(RM) main32.elf
		$(RM) main32.hex
		$(RM) $(SOURCE)/obj/non-free/processor.o
		$(COPY) $(SOURCE)/obj/non-free/$(MODEL)/processor.pic32 $(SOURCE)/obj/non-free/processor.o
